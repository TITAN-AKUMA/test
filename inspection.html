<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>LaserQR ‚Äî Inspection Officer</title>

<!-- QR Code Libraries -->
<script src="https://cdn.jsdelivr.net/npm/html5-qrcode/minified/html5-qrcode.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<style>
body { font-family: Inter, sans-serif; background:#f2efe9; margin:0; padding:0; }
nav { display:flex; justify-content:space-between; align-items:center; padding:10px 20px; background:#8b0000; color:white; flex-wrap:wrap; }
.nav-left h1 { font-size:22px; margin:0; }
.nav-right button { background:white; color:#8b0000; border:none; border-radius:8px; padding:6px 12px; font-weight:600; margin-left:10px; cursor:pointer; }
.nav-right button:hover { background:#f8f8f8; }

h2 { text-align:center; color:#36454f; margin-top:20px; font-size:18px; }

#scanner { max-width:400px; margin:30px auto; text-align:center; }
#camera-select { width:100%; margin-bottom:10px; padding:6px; border-radius:5px; border:1px solid #ccc; }
#reader { width:100%; margin:15px auto; min-height:250px; border:1px solid #ccc; border-radius:8px; }

.modal{display:none;position:fixed;top:0;left:0;width:100%;height:100%;background:rgba(0,0,0,0.5);justify-content:center;align-items:center;z-index:10000;}
.modal-content{background:#fff;padding:24px;border-radius:16px;max-width:900px;width:95%;position:relative;box-shadow:0 8px 25px rgba(0,0,0,0.3); max-height:85vh; overflow-y:auto;}
.modal-close{position:absolute;top:10px;right:10px;cursor:pointer;font-size:20px;font-weight:bold;color:#8b0000;}
.modal-content canvas{border:1px solid #ccc; margin-bottom:12px;}
.modal-content table{width:100%; border-collapse:collapse; margin-top:10px;}
.modal-content th, .modal-content td{padding:8px; border:1px solid #ccc; text-align:center;}
.modal-content tr:nth-child(even){background:#f8f8f8;}
.modal-content tr:hover td{background:#d1e7ff;}
.modal-content button{padding:6px 12px; border:none; border-radius:8px; background:#8b0000; color:white; font-weight:600; cursor:pointer;}

#scanned-controls{display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;}
#scanned-controls input{flex:1;padding:6px;border-radius:6px;border:1px solid #ccc;}
#scanned-controls button{margin-left:10px;}

.toast{position:fixed;top:20px;right:-350px;padding:14px 18px;background:#fff;border-left:6px solid #8b0000;box-shadow:0 8px 20px rgba(0,0,0,0.15);border-radius:12px;font-size:14px;color:#333;transition:all 0.5s ease;z-index:9999;}
.toast.show{right:20px;}
.toast.success{border-left-color:green;}
.toast.error{border-left-color:red;}
</style>
</head>
<body>

<!-- NAV -->
<nav>
  <div class="nav-left">
    <h1>üöÇ LaserQR - Inspection</h1>
  </div>
  <div class="nav-right">
    <button id="btn-dashboard">Dashboard</button>
    <button id="btn-view-scanned">View Scanned QR</button>
    <button onclick="logout()">Logout</button>
  </div>
</nav>

<!-- SCANNER -->
<div id="scanner">
  <h2>SCAN QR CODE</h2>
  <select id="camera-select"></select>
  <button onclick="startSelectedCamera()">Start Scanner</button>
  <div id="reader"></div>
  <div id="scan-result"></div>
</div>

<!-- SCANNED LIST MODAL -->
<div id="scanned-modal" class="modal">
  <div class="modal-content">
    <span class="modal-close" id="modal-close">&times;</span>
    <h3>All Scanned QR Codes</h3>
    <div id="scanned-controls">
      <input type="text" id="search-bar" placeholder="Search scanned QR...">
      <button id="analyze-ai-btn">Analyze with AI</button>
    </div>
    <div id="scanned-list"></div>
    <div id="analysis-report" style="margin-top:20px;"></div>
  </div>
</div>

<!-- QR VIEW MODAL -->
<div id="qr-view-modal" class="modal">
  <div class="modal-content">
    <span class="modal-close" id="qr-modal-close">&times;</span>
    <h3>QR Info</h3>
    <canvas id="qr-view-canvas"></canvas>
    <p id="qr-info"></p>
    <button id="download-qr-btn">Download QR</button>
  </div>
</div>

<div id="toast" class="toast"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-app.js";
import { getDatabase, ref, set, get } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-database.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/9.23.0/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyCzzNaUWyBn_z7A5Rjt_ooR3yEfA44heJA",
  authDomain: "laserqr-fd4fa.firebaseapp.com",
  databaseURL: "https://laserqr-fd4fa-default-rtdb.firebaseio.com",
  projectId: "laserqr-fd4fa",
  storageBucket: "laserqr-fd4fa.appspot.com",
  messagingSenderId: "191584527271",
  appId: "1:191584527271:web:71dad945fa1b18c0024c82",
  measurementId: "G-88ZMKEZT24"
};
const app = initializeApp(firebaseConfig);
const db = getDatabase(app);
const auth = getAuth(app);

function showToast(msg,type="info"){
  const toast=document.getElementById("toast");
  toast.textContent=msg;
  toast.className="toast show "+(type==="error"?"error":"success");
  setTimeout(()=>toast.classList.remove("show"),4000);
}

// AUTH
onAuthStateChanged(auth, user => { if(!user) window.location.href='index.html'; });
window.logout = function(){
  signOut(auth).then(()=>{ window.location.href='index.html'; })
  .catch(err=>showToast("Logout failed: "+err.message,"error"));
}

// CAMERA & SCANNER
let html5QrScanner = null, cameras=[];
Html5Qrcode.getCameras().then(camList=>{
  cameras=camList;
  const select = document.getElementById('camera-select');
  select.innerHTML="";
  cameras.forEach((cam,idx)=>{
    const option = document.createElement('option');
    option.value = cam.id;
    option.text = cam.label || `Camera ${idx+1}`;
    select.appendChild(option);
  });
}).catch(console.error);

window.startSelectedCamera = async function(){
  const cameraId = document.getElementById('camera-select').value;
  if(!cameraId){ showToast("No camera available!","error"); return; }
  try{
    if(html5QrScanner){ await html5QrScanner.stop(); html5QrScanner.clear(); }
    html5QrScanner = new Html5Qrcode("reader");
    html5QrScanner.start(cameraId, { fps:10, qrbox:250 }, onScanSuccess, err => console.warn(err));
  }catch(err){ showToast("Failed to start camera: "+err.message,"error"); }
}

// QR SCAN HANDLER
function onScanSuccess(decodedText){
  try{
    const dataObj = JSON.parse(decodedText);
    const qrId = dataObj.id || dataObj.ID || Math.random().toString(36).substring(2,8);
    dataObj.ID = qrId;
    dataObj.supplyDate = new Date().toISOString().split("T")[0]; // Auto add supply date
    set(ref(db,'inspection_qr/'+qrId), dataObj);
    displayScanResult(dataObj);
    showToast("QR scanned & inspected (supply date added)","success");
  }catch(e){ showToast("Invalid QR Code","error"); }
}

function displayScanResult(data){
  const div = document.getElementById('scan-result');
  let tableHTML='<table>';
  for(const key of ['ID','vendor','material','mfgDate','warranty','supplyDate']){
    if(data[key]!==undefined) tableHTML += `<tr><th>${key}</th><td>${data[key]}</td></tr>`;
  }
  tableHTML+='</table>';
  div.innerHTML = tableHTML;
}

// VIEW SCANNED QR MODAL
const modal = document.getElementById('scanned-modal');
const modalClose = document.getElementById('modal-close');
modalClose.onclick = ()=>modal.style.display="none";
window.onclick = e => {if(e.target===modal || e.target===qrModal) qrModal.style.display="none";}

document.getElementById('btn-view-scanned').onclick = async ()=> loadScannedList();

async function loadScannedList(){
  modal.style.display="flex";
  const listDiv = document.getElementById('scanned-list');
  listDiv.innerHTML='Loading...';
  const snap = await get(ref(db,'inspection_qr'));
  if(snap.exists()){
    const data = snap.val();
    let html='<table><tr><th>ID</th><th>Material</th><th>Vendor</th><th>MFG Date</th><th>Warranty</th><th>Supply Date</th><th>QR</th></tr>';
    Object.values(data).forEach(item=>{
      html+=`<tr>
        <td>${item.ID || ''}</td>
        <td>${item.material || ''}</td>
        <td>${item.vendor || ''}</td>
        <td>${item.mfgDate || ''}</td>
        <td>${item.warranty || ''}</td>
        <td>${item.supplyDate || ''}</td>
        <td><button onclick='showQRCodeModal(${JSON.stringify(item).replace(/'/g,"\\'")})'>View QR</button></td>
      </tr>`;
    });
    html+='</table>';
    listDiv.innerHTML=html;
  }else{ listDiv.innerHTML='No QR codes scanned yet.'; }
}

// AI ANALYSIS
document.getElementById('analyze-ai-btn').onclick = async ()=>{
  const snap = await get(ref(db,'inspection_qr'));
  const reportDiv = document.getElementById('analysis-report');
  if(!snap.exists()){ reportDiv.innerHTML="<p>No data for analysis</p>"; return; }
  const data = snap.val();
  let expired=[];
  Object.values(data).forEach(item=>{
    let warrantyMonths = parseInt(item.warranty)||0;
    if(item.supplyDate){
      let supplyDate = new Date(item.supplyDate);
      let expiry = new Date(supplyDate);
      expiry.setMonth(expiry.getMonth()+warrantyMonths);
      if(new Date()>expiry){ expired.push(item); }
    }
  });

  let html="<h4>AI Analysis Report</h4>";
  if(expired.length){ 
    html+="<h5>‚ö†Ô∏è Warranty Finished Materials:</h5><ul>";
    expired.forEach(i=> html+=`<li>${i.ID} - ${i.material} (Vendor: ${i.vendor})</li>`);
    html+="</ul>";
  }
  if(!expired.length) html+="<p>‚úÖ All materials are within warranty.</p>";
  reportDiv.innerHTML=html;
}

// QR VIEW POPUP MODAL
const qrModal = document.getElementById('qr-view-modal');
const qrModalClose = document.getElementById('qr-modal-close');
qrModalClose.onclick = ()=> qrModal.style.display="none";

window.showQRCodeModal = function(item){
  qrModal.style.display = "flex";
  document.getElementById('qr-info').innerHTML = `
    ID: ${item.ID || ''}<br>
    Vendor: ${item.vendor || ''}<br>
    Material: ${item.material || ''}<br>
    MFG Date: ${item.mfgDate || ''}<br>
    Warranty: ${item.warranty || ''} months<br>
    Supply Date: ${item.supplyDate || ''}
  `;
  const canvas = document.getElementById('qr-view-canvas');
  QRCode.toCanvas(canvas, JSON.stringify(item), {width:200});

  // Download QR
  document.getElementById('download-qr-btn').onclick = ()=>{
    const link = document.createElement('a');
    link.href = canvas.toDataURL("image/png");
    link.download = (item.ID || 'qr')+".png";
    link.click();
  }
}
</script>
</body>
</html>